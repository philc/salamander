<!DOCTYPE html>
<html>
<head>
  <title>Salamander</title>

  <script type="text/javascript" charset="utf-8">
      var exports = {};
  </script>
  <script src="/js/utils.js"></script>
  <script type="text/javascript" src="/js/socket/socket.io.js"></script>
  <script type="text/javascript" src="/js/protocol.js"></script>
  <script src="/js/jquery-1.4.2.js"></script>
  <script src="/js/engine.js"></script>
  <script src="/js/rendered_board.js"></script>
  <link rel="stylesheet" href="/styles.css" type="text/css">

  <script>
    io.setPath('/js/socket/');
    var RELOAD_STRING = "reload";

    // Add these styles to the page early so the page will take shape right away and the start screen
    // will properly center itself.
    var cellSize = 10;
    addPageStyle("#board div { width: " + cellSize + "px; height: " + cellSize + "px; }");
    addPageStyle("#board .obstacleCorner { width: " + (2 * cellSize) + "px; " +
                 "height: " + ( 3 * cellSize) + "px; }");
    addPageStyle("#board { width: " + (BOARD_WIDTH * cellSize) + "px; height: " +
                 (BOARD_HEIGHT * cellSize) + "px; }");

    $(document).ready(function() {
      //init page state
      var reloaded = document.location.toString().indexOf(RELOAD_STRING) >= 0;
      // if (reloaded) {
      //   $("#restartName").focus();
      //   $("#restart").show();
      // }
      // else {
      //   $("#startName").focus();
      //   $("#start").fadeIn();
      // }

      if (!autoStart)
        showStartScreen();
      
      var socket = new io.Socket(null, {port: 80});
      socket.connect();
      var gameClient = new protocol.GameClient(socket);
      socket.on('message', function(msg){
        var type = protocol.messageType(msg);
        if (type === protocol.Types.GameState) {
          gameClient.receive(protocol.messageData(msg));
        }
        else if (type === protocol.Types.Users) {
          handleUsers(protocol.messageData(msg));
        }
      });

      // Used is used for development to skip the start screen.
      var autoStart = document.location.toString().indexOf("autostart") >= 0;

      board = new RenderedBoard(BOARD_WIDTH, BOARD_HEIGHT, cellSize, $("#board"));
      engine = new ClientEngine(window.board);
      engine.registerClient(gameClient);
      engine.addEventListener("snakeDead", function() {
        setTimeout(function() {
          if (reloaded) {
            window.location = window.location;
          }
          else {
            window.location = window.location+"?"+RELOAD_STRING+"=yes";
          }
        }, 2000);
      });

      // Arrow key control code
      KEYCODE_TO_DIRECTION = { 37: [-1,0], 38: [0,-1], 39: [1,0], 40: [0,1] }; // Left, Up, Right, Down
      $(document).keydown(function(e) {
        direction = KEYCODE_TO_DIRECTION[e.keyCode];
        if (direction) {
          engine.moveSnake(direction);
          e.preventDefault();
        }
      });

      //screen management
      $("#pauseButton").click(function() { engine.togglePause(); });
      
      function startGameEvent(event, name) {
        hideStartScreen();
        if (!autoStart)
          startGame(name);
        event.preventDefault();
      }

      $("#startScreen form").submit(function(event) {
        startGameEvent(event, $("#startScreen input[name=name]").val());
      });

      $("#restartForm").submit(function(event) { startGameEvent(event, $("#restartName").val()); });

      $("#startScreen #startButton").click(function(event) {
        $("#startScreen form").submit();
        event.preventDefault();
      });
      $(".restartButton").click(function(event) {
        $("#restartForm").submit();
        event.preventDefault();
      })
      
      if (autoStart) { startGame(""); }
    });

    function showStartScreen() {
      centerWithinParent($("#startScreen"));
      $("#startScreen input[name=name]").focus();
    }

    function hideStartScreen() {
      $("#startScreen").hide();
    }

    function startGame(name) {
      console.log("startGame");
      if (!name) { name = (new Date()).getTime()+"";}
      engine.setUserProps({"name":name});
      engine.startGame();
    }

    function addPageStyle(css, head) {
      var style;
      head = head || document.getElementsByTagName("head")[0];
      style = document.createElement("style");
      style.type = "text/css";
      style.appendChild(document.createTextNode(css));
      head.appendChild(style);
      return style;
    }
    
    //handle users data
    var snakeTitles = {
      "500":"Black Mamba",
      "450":"King Cobra",
      "400":"Death Adder",
      "350":"Anaconda",
      "300":"Viper",
      "250":"Python",
      "200":"Taipan",
      "150":"Boomslang",
      "100":"Valley Rattlesnake",
      "0":"Garden Snake",
    }
    var snakeGraduations = [500,450,400,350,300,250,200,150,100,0];
    var myPrevTitle = snakeTitles["0"];
    
    function handleUsers(users) {
      var totalUsers = users.length;
      //sort from largest snake down
      users.sort(function(a,b) { return b.snake.size - a.snake.size; });
      
      var me = false;
      var maxTop = 10;
      var topFew = (users.length > maxTop) ? maxTop : users.length;
      var output = "";
      var size = 0;
      var title = "";
      for (var i=0; i < topFew; i++) {
        me = engine.mySnake && (engine.mySnake.snakeId === users[i].snake.snakeId);
        size = users[i].snake.size;
        for (var j = 0; j < snakeGraduations.length; j++){
          if (size >= snakeGraduations[j]) {
            title = snakeTitles[""+snakeGraduations[j]];
            break;
          }
        }
        if (me) {
          output += "You: ";
          if (title !== myPrevTitle) {
            announce(title);
            myPrevTitle = title;
          }
        }
        output += ""+ users[i].props.name + ": " + size + " - " + title + "<br/>";
      }
      
      $("#leaderboard").empty().append(totalUsers + " Users<br/>Top Players:<br/>" + output);
    }
    
    function announce(text) {
      var myHead = engine.mySnake.head();
      var div = board.divs[myHead[0]][myHead[1]];
      var announcement = $('<div class="announcement"></div>').html(text).css({width: "1000px", top: div.css("top"), left: div.css("left")});
      console.log(announcement);
      $("#board").append(announcement);
      announcement.animate({opacity: 0,fontSize: "3em", marginLeft: "-100px"}, 1500, function() {
        announcement.remove();
      });
    }
  </script>

</head>

<body>
  <div id="board"></div>

  <div id="hud">
    <div class="innerBox">
      <!--button id="pauseButton">Pause</button-->
      <div id="leaderboard">
      </div>
        <a href="http://nodeknockout.com/teams/salamander" target="nko" title="Help me win Node.js KO!"><img style="position: fixed; top: 20px; right: 20px; border: 0px;" src="http://nodeknockout.com/images/voteko.png" alt="Help me win Node.js KO!"/></a>
    </div>
  </div>

  <div class="centeredPopupContainer">
    <div id="startScreen" class="popup">
      <form>
        <img src="/images/logo.png" id="logo" />
        <div id="tagline"><img src="/images/tagline.png" id="tagline" /></div>

        <p class="intro">
          <span class="contents">
            Devour your foes and grow to become <br/>
            the <strong>Black Mamba</strong>. Have no mercy!
          </span>
        </p>

        <p>
          <input type="text" name="name" value="Your nickname" />
          <a id="startButton" href="#">Enter the Arena</a>
        </p>

        <p class="footer">For the best gameplay, maximize your browser window.</p>
      </form>
    </div>
  </div>

  <!--hidden by default added when needed-->
  <div id="restart" class="popup" style="display: none;">
    <div class="innerBox">
      <img src="images/title.png" width="400" height="50" title="Snake Arena"/>
      <form action="prototype_submit" method="get" accept-charset="utf-8" id="restartForm">
        Play Again?
        Name: <input type="text" id="restartName"/>
        <a class="restartButton button" href="#">Restart</a>
      </form>
    </div>
  </div>
  
  <div id="announcements"></div>
</body>
</html>
