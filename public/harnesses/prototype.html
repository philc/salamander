<!DOCTYPE html>
<html>
<head>
  <title>Salamander</title>

  <script type="text/javascript" charset="utf-8">
      var exports = {};
  </script>
  <script src="/js/utils.js"></script>
  <script type="text/javascript" src="/js/socket/socket.io.js"></script>
  <script type="text/javascript" src="/js/protocol.js"></script>
  <script src="/js/jquery-1.4.2.js"></script>
  <script src="/js/engine.js"></script>
  <script src="/js/rendered_board.js"></script>
  <link rel="stylesheet" href="/styles.css" type="text/css">

  <script>
    io.setPath('/js/socket/');

    $(document).ready(function() {      
      var socket = new io.Socket(null, {port: 80});
      socket.connect();
      var gameClient = new protocol.GameClient(socket);
      socket.on('message', function(msg){
        var type = protocol.messageType(msg);
        if (type === protocol.Types.GameState) {
          gameClient.receive(protocol.messageData(msg));
        }
        else if (type === protocol.Types.Users) {
          var users = protocol.messageData(msg);
          var totalUsers = users.length;
          users.sort(function(a,b) {
            return b.size - a.size;
          });
          
          var topFew = (users.length > 3) ? 3 : users.length;
          var output = "";
          for (var i=0; i < topFew; i++) {
            output += ""+ users[i].snakeId + "<br/>";
          }
          
          $("#leaderboard").empty().append(totalUsers + " Users<br/>Top Players:<br/>" + output);
        }
      });

      var autoStart = false;//dev
      var cellSize = 10;
      addPageStyle("#board div { width: " + cellSize + "px; height: " + cellSize + "px; }");

      board = new RenderedBoard(BOARD_WIDTH, BOARD_HEIGHT, cellSize, $("#board"));
      engine = new ClientEngine(window.board);
      engine.registerClient(gameClient);

      // Arrow key control code
      KEYCODE_TO_DIRECTION = { 37: [-1,0], 38: [0,-1], 39: [1,0], 40: [0,1] }; // Left, Up, Right, Down
      $(document).keydown(function(e) {
        direction = KEYCODE_TO_DIRECTION[e.keyCode];
        if (direction) {
          engine.moveSnake(direction);
          e.preventDefault();
        }
      });

      $("#pauseButton").click(function() { engine.togglePause(); });
      $(".startButton").click(function(event) {
        if (!autoStart) {
          startGame();
        }
        event.preventDefault(); 
      });
      
      if (autoStart) { startGame(); }
    });

    function startGame() {
      console.log("startGame");
      engine.startGame();
      $(".popup").hide();
    }

    function addPageStyle(css, head) {
      var style;
      head = head || document.getElementsByTagName("head")[0];
      style = document.createElement("style");
      style.type = "text/css";
      style.appendChild(document.createTextNode(css));
      head.appendChild(style);
      return style;
    }
  </script>

</head>

<body>
  <div id="board"></div>

  <div id="hud">
    <button id="pauseButton">Pause</button>
    <div id="leaderboard">
    </div>
  </div>
  
  <div id="start" class="popup">
    <div class="innerBox">
      <h1>Welcome to MO-SNAKES-MO-PROBLEMS!</h1>
      <a class="startButton button" href="#">Start</a>
    </div>
  </div>
  
  <!--hidden by default added when needed-->
  <div id="restart" class="popup" style="display: none;">
    <div class="innerBox">
      <h1>Oooh noooo! Wanna play again?</h1>
      <a class="startButton button" href="#">Restart</a>
    </div>
  </div>
  
</body>
</html>
